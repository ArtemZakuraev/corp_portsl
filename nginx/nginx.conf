# Nginx конфигурация для OnlyOffice с SSL

# Уровень логирования: error - только ошибки
# Это уменьшает количество логов при graceful shutdown
# Примечание: некоторые системные сообщения (запуск/остановка воркеров) всё равно будут логироваться в stdout
error_log /dev/stderr error;

upstream onlyoffice_backend {
    server onlyoffice:80;
}

server {
    listen 443 ssl;
    http2 on;
    server_name localhost;

    # SSL сертификаты
    ssl_certificate /etc/nginx/ssl/onlyoffice.crt;
    ssl_certificate_key /etc/nginx/ssl/onlyoffice.key;

    # SSL настройки
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Увеличиваем размер тела запроса для больших документов
    client_max_body_size 100M;

        # Проксирование запросов к OnlyOffice
        location / {
            # ВАЖНО: Используем абсолютный URL для proxy_pass без завершающего слэша
            # Это предотвращает редиректы от OnlyOffice
            proxy_pass http://onlyoffice_backend;
            
            # Правильный Host заголовок - передаем исходный Host из браузера
            # ВАЖНО: Для стандартного HTTPS порта 443 не указываем порт в Host заголовке
            # Это важно для того, чтобы OnlyOffice делал правильные редиректы
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # Перехватываем и переписываем Location заголовки в редиректах от OnlyOffice
            # OnlyOffice может возвращать редиректы на http://localhost/welcome/ (без порта)
            # Переписываем их на правильный адрес с HTTPS протоколом
            # ВАЖНО: Используем https (не http), так как nginx работает с SSL
            # Для стандартного HTTPS порта 443 не указываем порт в редиректах
            
            # Сначала обрабатываем полные URL с разными вариантами
            # http://localhost (без порта или с портами 80/443)
            proxy_redirect http://localhost/ https://$host/;
            proxy_redirect http://localhost/welcome/ https://$host/welcome/;
            proxy_redirect http://localhost:80/ https://$host/;
            proxy_redirect http://localhost:80/welcome/ https://$host/welcome/;
            proxy_redirect http://localhost:443/ https://$host/;
            proxy_redirect http://localhost:443/welcome/ https://$host/welcome/;
            # https://localhost (без порта или с портом 443)
            proxy_redirect https://localhost/ https://$host/;
            proxy_redirect https://localhost/welcome/ https://$host/welcome/;
            proxy_redirect https://localhost:443/ https://$host/;
            proxy_redirect https://localhost:443/welcome/ https://$host/welcome/;
            # Редиректы на onlyoffice (внутренний адрес контейнера)
            proxy_redirect http://onlyoffice/ https://$host/;
            proxy_redirect http://onlyoffice:80/ https://$host/;
            proxy_redirect http://onlyoffice/welcome/ https://$host/welcome/;
            proxy_redirect http://onlyoffice:80/welcome/ https://$host/welcome/;
            proxy_redirect https://onlyoffice/ https://$host/;
            proxy_redirect https://onlyoffice:443/ https://$host/;
            proxy_redirect https://onlyoffice/welcome/ https://$host/welcome/;
            proxy_redirect https://onlyoffice:443/welcome/ https://$host/welcome/;
            
            # ВАЖНО: Обрабатываем относительные редиректы (без протокола и хоста)
            # Эти правила должны быть после полных URL, чтобы не перезаписывать их
            # Используем regex для более точного совпадения относительных путей
            proxy_redirect ~^/welcome/?$ https://$host/welcome/;
            proxy_redirect ~^/$ https://$host/;
            
            # CORS заголовки для OnlyOffice API
            add_header Access-Control-Allow-Origin * always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
            add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
            add_header Access-Control-Allow-Credentials "true" always;
            
            # Обработка OPTIONS запросов для CORS
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin * always;
                add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE" always;
                add_header Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With" always;
                add_header Access-Control-Max-Age 1728000;
                add_header Content-Type 'text/plain; charset=utf-8';
                add_header Content-Length 0;
                return 204;
            }

            # Настройки для WebSocket (если нужно)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";

            # Таймауты
            proxy_connect_timeout 300;
            proxy_send_timeout 300;
            proxy_read_timeout 300;
            send_timeout 300;
            
            # Буферизация отключена для статических файлов
            proxy_buffering off;
            
            # Заголовки для кэширования статических файлов
            proxy_ignore_headers "Cache-Control";
            proxy_hide_header "Cache-Control";
            add_header Cache-Control "public, max-age=3600" always;
        }
}


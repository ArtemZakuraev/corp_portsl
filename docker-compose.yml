version: "3.9"

services:
  db:
    image: postgres:16-alpine
    container_name: corp_portal_db
    restart: unless-stopped
    environment:
      POSTGRES_DB: corp_portal
      POSTGRES_USER: corp_portal
      POSTGRES_PASSWORD: corp_portal
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U corp_portal -d corp_portal"]
      interval: 5s
      timeout: 5s
      retries: 5

  web:
    build: .
    container_name: corp_portal_web
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      DJANGO_SECRET_KEY: "change-me-in-prod"
      DJANGO_DEBUG: "True"
      DJANGO_ALLOWED_HOSTS: "localhost,127.0.0.1,web"
      POSTGRES_DB: corp_portal
      POSTGRES_USER: corp_portal
      POSTGRES_PASSWORD: corp_portal
      POSTGRES_HOST: db
      POSTGRES_PORT: "5432"
      ADMIN_USERNAME: "admin"
      ADMIN_PASSWORD: "adminpassword"
      ADMIN_EMAIL: "admin@example.com"
      # EMAIL_* переменные вы можете переопределить в .env
      EMAIL_HOST: "smtp.example.com"
      EMAIL_PORT: "587"
      EMAIL_USE_TLS: "True"
      EMAIL_HOST_USER: ""
      EMAIL_HOST_PASSWORD: ""
      DEFAULT_FROM_EMAIL: "no-reply@example.com"
    ports:
      - "8000:8000"
    volumes:
      - .:/app
      - ./data:/app/data
      - ./media/mattermost_files:/app/media/mattermost_files
      - ./certificates:/certs:ro
    networks:
      - default

  # Генератор SSL сертификатов
  cert_generator:
    image: alpine:latest
    container_name: corp_portal_cert_generator
    command: sh -c "apk add --no-cache openssl && mkdir -p /output && openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /output/onlyoffice.key -out /output/onlyoffice.crt -subj '/C=RU/ST=Moscow/L=Moscow/O=CorpPortal/CN=localhost' -addext 'subjectAltName=DNS:localhost,DNS:127.0.0.1,IP:127.0.0.1' && echo 'SSL certificates generated successfully'"
    volumes:
      - ./certificates:/output
    profiles:
      - cert

  # Nginx reverse proxy для OnlyOffice с SSL
  onlyoffice_nginx:
    image: nginx:alpine
    container_name: corp_portal_onlyoffice_nginx
    restart: unless-stopped
    depends_on:
      - onlyoffice
    ports:
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./certificates:/etc/nginx/ssl:ro
    networks:
      - default
    command: ["/bin/sh", "-c", "if [ ! -f /etc/nginx/ssl/onlyoffice.crt ]; then echo 'ERROR: SSL certificate not found. Run: docker-compose --profile cert run --rm cert_generator'; exit 1; fi; nginx -g 'daemon off;'"]

  onlyoffice:
    image: onlyoffice/documentserver:latest
    container_name: corp_portal_onlyoffice
    restart: unless-stopped
    depends_on:
      - web
    environment:
      - JWT_ENABLED=false
      # Разрешаем OnlyOffice подключаться к приватным IP адресам
      - DS_ALLOW_PRIVATE_IP=true
      # Отключаем SSL на OnlyOffice (nginx будет обрабатывать SSL)
      - SSL_ENABLED=false
    expose:
      - "80"
    volumes:
      - ./data:/var/www/onlyoffice/Data
    networks:
      - default
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # collabora:
    # image: collabora/code:latest
    # container_name: corp_portal_collabora
    # restart: unless-stopped
    # depends_on:
      # - web
    # environment:
      # - domain=localhost\|127.0.0.1\|*
      # - username=admin
      # - password=admin
      # - extra_params=--o:ssl.enable=false --o:ssl.termination=false --o:storage.filesystem[@allow]=true --o:wopi.host[0]=http://web:8000 --o:security.capabilities=false --o:storage.wopi.host[0]=http://web:8000
    # ports:
      # - "9980:9980"
    # cap_add:
      # - MKNOD
      # - SYS_ADMIN
    # security_opt:
      # - apparmor:unconfined
    # privileged: true
    # volumes:
      # - ./data:/var/lib/coolwsd
    # networks:
      # - default



